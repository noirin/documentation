<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Part III, Chapter 9. Low-level method: embedding com.xmlmind.ditac.preprocess.PreProcessor</title>
      <link rel="stylesheet" type="text/css" href="resources/basic.css" />
      <meta name="generator" content="XMLmind DITA Converter 2.2.3" />
   </head>
   <body>
      <div class="page-navigation-bar">
         <table border="0" cellspacing="0" width="100%" class="page-navigation-layout">
            <tr valign="top">
               <td align="left"><a href="index.html" class="navigation-link" title="First page: XMLmind DITA Converter Manual" accesskey="S"><img class="navigation-icon" src="resources/first.png" alt="First page" width="16" height="16" /></a></td>
               <td align="left"><a href="embed1.html" class="navigation-link" title="Previous page: Part III, Chapter 8. High-level method: embedding com.xmlmind.ditac.convert.Converter" accesskey="P"><img class="navigation-icon" src="resources/previous.png" alt="Previous page" width="16" height="16" /></a></td>
               <td width="25%" align="left"><span class="page-navigation-previous">Part III, Chapter 8. High-level method: embedding com.xmlmind.ditac.convert.Converter</span></td>
               <td width="40%" align="center"><span class="page-navigation-current">Part III, Chapter 9. Low-level method: embedding com.xmlmind.ditac.preprocess.PreProcessor</span> <span class="page-navigation-page">(16 / 19)</span></td>
               <td width="25%" align="right"><span class="page-navigation-next">Appendix A. Translating the messages generated by ditac</span></td>
               <td align="right"><a href="translating_messages.html" class="navigation-link" title="Next page: Appendix A. Translating the messages generated by ditac" accesskey="N"><img class="navigation-icon" src="resources/next.png" alt="Next page" width="16" height="16" /></a></td>
               <td align="right"><a href="manual-8.html" class="navigation-link" title="Last page: Index" accesskey="E"><img class="navigation-icon" src="resources/last.png" alt="Last page" width="16" height="16" /></a></td>
            </tr>
         </table>
         <hr class="page-navigation-top-separator" />
      </div>
      <div id="embed2" class="topic">
         <h2 class="chapter-title">Chapter 9. Low-level method: embedding
            <tt class="apiname">com.xmlmind.ditac.preprocess.PreProcessor</tt></h2>
         <div class="body">
            <div class="p">This method consists in first invoking the <a href="../api/com/xmlmind/ditac/preprocess/PreProcessor.html" class="xref" target="_blank">PreProcessor <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> in order to pre-process the DITA
               source files into a <tt class="filepath">ditac_lists.ditac_lists</tt> file and
               one or more <tt class="filepath">.ditac</tt> files; then invoking the <a href="http://saxon.sourceforge.net/" class="xref" target="_blank">Saxon <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> XSLT 2.0 engine in order to transform all
               the <tt class="filepath">.ditac</tt> files.
            </div>
            <div class="p">For some output formats, PDF, RTF, etc, the final third step consists
               in invoking an XSL-FO processor such as <a href="http://xmlgraphics.apache.org/fop/" class="xref" target="_blank">Apache
                  FOP <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> in order to convert the XSL-FO generated by the XSLT
               stylesheets to the desired output format.
            </div>
            <div class="p">The full source code of the <tt class="apiname">Embed2</tt> sample is found
               in <a href="embed/Embed2.java" class="xref" target="_blank"><tt class="filepath">Embed2.java</tt> <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
            </div>
            <ol class="ol">
               <li class="li">
                  <div class="p">Invoke the ditac <tt class="apiname">PreProcessor</tt> to pre-process
                     the DITA source files into a
                     <tt class="filepath">ditac_lists.ditac_lists</tt> file and one or more
                     <tt class="filepath">.ditac</tt> files.
                  </div>
                  <ol class="ol">
                     <li class="li">
                        <div class="p">Create and configure the
                           <tt class="apiname">PreProcessor</tt>.
                        </div><pre class="pre">Console console = new Console() {
    public void showMessage(String message, MessageType messageType) {
        System.err.println(message);
    }
};

PreProcessor preProc = new PreProcessor(console);
preProc.setChunking(Chunking.SINGLE);
preProc.setMedia(Media.SCREEN);

ImageCopier imageCopier = new ImageCopier();
imageCopier.parseParameters("img");
preProc.setImageHandler(imageCopier);</pre><ul class="ul">
                           <li class="li">
                              <div class="p"><a href="../api/com/xmlmind/util/Console.html" class="xref" target="_blank">Console <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> is a very simple interface.
                                 Implementing this interface allows to do whatever you want with
                                 the messages reported by a
                                 <tt class="apiname">PreProcessor</tt>.
                              </div>
                           </li>
                           <li class="li">
                              <div class="p">Specifiying <a href="../api/com/xmlmind/ditac/preprocess/PreProcessor.html#setChunking(com.xmlmind.ditac.preprocess.Chunking)" class="xref" target="_blank"><tt class="codeph">preProc.setChunking(Chunking.SINGLE)</tt> <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>
                                 allows to generate a single HTML page using a DITA map designed
                                 to generate multiple HTML pages.
                              </div>
                           </li>
                           <li class="li">
                              <div class="p">A <tt class="apiname">PreProcessor</tt> is not concerned about
                                 the <i class="i">exact</i> output format. However its behaves differently
                                 depending on the target <a href="../api/com/xmlmind/ditac/preprocess/Media.html" class="xref" target="_blank">Media <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
                              </div>
                           </li>
                           <li class="li">
                              <div class="p">A <tt class="apiname">PreProcessor</tt> handles to an <a href="../api/com/xmlmind/ditac/preprocess/ImageHandler.html" class="xref" target="_blank">ImageHandler <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> all the images files
                                 referenced in the DITA source using relative URLs. An
                                 <tt class="apiname">ImageHandler</tt> is registered with a
                                 <tt class="apiname">PreProcessor</tt> using method <a href="../api/com/xmlmind/ditac/preprocess/PreProcessor.html#setImageHandler(com.xmlmind.ditac.preprocess.ImageHandler)" class="xref" target="_blank">setImageHandler <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
                              </div>
                              <div class="p">In the case of
                                 the <tt class="apiname">Embed2</tt> sample, we use the simplest
                                 possible <tt class="apiname">ImageHandler</tt> which is <a href="../api/com/xmlmind/ditac/convert/ImageCopier.html" class="xref" target="_blank">ImageCopier <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
                              </div>
                           </li>
                        </ul>
                     </li>
                     <li class="li">
                        <div class="p">Pre-process the DITA source files.</div><pre class="pre">URL inFileURL = null;
try {
    inFileURL = inFile.toURI().toURL();
} catch (MalformedURLException cannotHappen) {}

File[] preProcFiles = null;
try {
    preProcFiles = preProc.process(new URL[] { inFileURL }, outFile);
} catch (IOException e) {
    console.showMessage(e.toString(), Console.MessageType.ERROR);
}
if (preProcFiles == null) {
    return false;
}</pre><div class="p">The <a href="../api/com/xmlmind/ditac/preprocess/PreProcessor.html#process(java.net.URL[],%20java.io.File)" class="xref" target="_blank">process <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> method of a PreProcessor returns
                           <tt class="codeph">null</tt> if an error other than an
                           <tt class="apiname">IOException</tt> has caused the pre-processing to
                           fail. When this is the case, errors messages are displayed on the
                           <tt class="apiname">Console</tt>.
                        </div>
                        <div class="p">Note that a
                           <tt class="apiname">PreProcessor</tt> is not thread-safe. Each thread must
                           own its <tt class="apiname">PreProcessor</tt>. However, the
                           <tt class="apiname">process</tt> method of a
                           <tt class="apiname">PreProcessor</tt> may be invoked several
                           times.
                        </div>
                     </li>
                  </ol>
               </li>
               <li class="li">
                  <div class="p">Invoke the Saxon XSLT 2.0 engine, in order to transform all the
                     <tt class="filepath">.ditac</tt> files. Note that this is done using the
                     standard <a href="http://java.sun.com/j2ee/1.4/docs/tutorial/doc/JAXPIntro.html" class="xref" target="_blank">JAXP <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> API.
                  </div>
                  <ol class="ol">
                     <li class="li">
                        <div class="p">Pass <i class="i">required system parameters</i> to the XSLT
                           stylesheets, in addition to the normal, user, parameters.
                        </div><pre class="pre">String ditacListsURI = "";

int count = preProcFiles.length;
for (int i = 0; i &lt; count; ++i) {
    File ditacFile = preProcFiles[i];

    if (ditacFile.getPath().endsWith(".ditac_lists")) {
        ditacListsURI = ditacFile.toURI().toASCIIString();
        break;
    }
}

String[] params = {
    "ditacListsURI", ditacListsURI,
    "xsl-resources-directory", "res",
    "use-note-icon", "yes",
    "default-table-width", "100%"
};</pre><div class="p">These required system parameters are:</div>
                        <ul class="ul">
                           <li class="li"><a href="xsltParams.html#xsltParams__ditacListsURI" class="xref">ditacListsURI</a>,
                              always required.
                           </li>
                           <li class="li"><a href="xsltParams.html#xsltParams__foProcessor" class="xref">foProcessor</a>,
                              required by the XSLT stylesheets that generate XSL-FO.
                           </li>
                           <li class="li"><a href="xsltParams.html#xsltParams__chmBasename" class="xref">chmBasename</a>,
                              <a href="xsltParams.html#xsltParams__hhpBasename" class="xref">hhpBasename</a>,
                              required by the XSLT stylesheets that generate HTML Help.
                           </li>
                        </ul>
                     </li>
                     <li class="li">
                        <div class="p">Use the Saxon XSLT 2.0 engine to create a
                           <tt class="apiname">TransformerFactory</tt>, then configure this
                           <tt class="apiname">TransformerFactory</tt>.
                        </div><pre class="pre">private static
TransformerFactory createTransformerFactory(URIResolver uriResolver, 
                                            ErrorListener errorListener) 
    throws Exception {
    Class&lt;?&gt; cls = Class.forName("net.sf.saxon.TransformerFactoryImpl");
    TransformerFactory transformerFactory = 
        (TransformerFactory) cls.newInstance();

    ExtensionFunctions.registerAll(transformerFactory);

    transformerFactory.setURIResolver(uriResolver);
    transformerFactory.setErrorListener(errorListener);

    return transformerFactory;
}</pre><ul class="ul">
                           <li class="li">
                              <div id="embed2__saxon_9_2_plus" class="p">Creating an instance of Saxon 9.2+ is
                                 absolutely needed. XMLmind DITA Converter is not designed to
                                 work with any other XSLT engine (e.g. the Xalan XSLT 1.0 engine,
                                 which is part of the <span class="tm">Java™</span>
                                 runtime).
                              </div>
                           </li>
                           <li class="li">
                              <div class="p">The ditac XSLT 2.0 stylesheets make use of a few XSLT
                                 extension functions written in <span class="tm">Java™</span>. These
                                 extension functions must be registered with Saxon. This is done
                                 using <a href="../api/com/xmlmind/ditac/xslt/ExtensionFunctions.html#registerAll(javax.xml.transform.TransformerFactory)" class="xref" target="_blank">ExtensionFunctions.registerAll <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
                              </div>
                           </li>
                        </ul>
                     </li>
                     <li class="li">
                        <div class="p">Create and configure a
                           <tt class="apiname">Transformer</tt>.
                        </div><pre class="pre">private static Transformer createTransformer(String[] params, 
                                             Console console) 
    throws Exception {
    URIResolver uriResolver = Resolve.createURIResolver();
    ErrorListener errorListener = new ConsoleErrorListener(console);

    TransformerFactory factory = createTransformerFactory(uriResolver,
                                                          errorListener);

    File xslFile = new File(path("../../../xsl/xhtml/html.xsl"));
    Transformer transformer = 
        factory.newTransformer(new StreamSource(xslFile));

    transformer.setURIResolver(uriResolver);
    transformer.setErrorListener(errorListener);

    for (int i = 0; i &lt; params.length; i += 2) {
        transformer.setParameter(params[i], params[i+1]);
    }

    return transformer;
}</pre><ul class="ul">
                           <li class="li">
                              <div class="p"><a href="../api/com/xmlmind/ditac/util/Resolve.html" class="xref" target="_blank">Resolve <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> is a helper class making it easy
                                 to use the services of <a href="http://www.oasis-open.org/committees/tc_home.php?wg_abbrev=entity" class="xref" target="_blank">XML Catalog resolvers <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a>.
                              </div>
                              <div class="p">By default,
                                 <tt class="apiname">Resolve</tt> automatically loads all the XML
                                 catalogs specified using the <tt class="tt">xml.catalog.files</tt> <span class="tm">Java™</span> system property. Excerpts of the
                                 <b class="cmdname">ant</b> <a href="embed/build.xml" class="xref" target="_blank">build.xml <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> file:
                              </div><pre class="pre">&lt;target name="embed2" depends="compile,clean_embed2"&gt;
  &lt;java classpathref="cp" fork="yes" classname="Embed2"&gt;
    <b class="b">&lt;sysproperty key="xml.catalog.files" 
                 value="${ditac.dir}/schema/catalog.xml" /&gt;</b>
    &lt;arg value="${ditac.dir}/docsrc/manual/manual.ditamap" /&gt;
    &lt;arg value="manual.html" /&gt;
  &lt;/java&gt;
&lt;/target&gt;</pre><div class="p">However, static method <a href="../api/com/xmlmind/ditac/util/Resolve.html#setResolverFactory(com.xmlmind.ditac.util.ResolverFactory)" class="xref" target="_blank">setResolverFactory <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> allows to configure
                                 this thread-safe utility class (used by ditac in many places)
                                 differently.
                              </div>
                           </li>
                           <li class="li">
                              <div class="p"><a href="../api/com/xmlmind/ditac/convert/ConsoleErrorListener.html" class="xref" target="_blank">ConsoleErrorListener <img border="0" src="resources/new_window.png" alt="Opens in new window" width="11" height="10" /></a> is an
                                 implementation of <tt class="apiname">ErrorListener</tt> which
                                 displays its messages on a <tt class="apiname">Console</tt>. 
                              </div>
                           </li>
                        </ul>
                     </li>
                     <li class="li">
                        <div class="p">Invoke the Transformer to transform each
                           <tt class="filepath">.ditac</tt> file.
                        </div><pre class="pre">for (int i = 0; i &lt; count; ++i) {
    File ditacFile = preProcFiles[i];

    String ditacFilePath = ditacFile.getPath();
    if (ditacFilePath.endsWith(".ditac")) {
        File transformedFile = new File(
            ditacFilePath.substring(0, ditacFilePath.length()-5) + 
            "html");

        try {
            transformer.transform(new StreamSource(ditacFile), 
                                  new StreamResult(transformedFile));
        } catch (Exception e) {
            console.showMessage(e.toString(), 
                                Console.MessageType.ERROR);
            cleanUp(preProcFiles);
            return false;
        }
    }
}</pre><div class="p">In the case of <tt class="apiname">Embed2</tt>, the above loop is not
                           strictly needed. We specified
                           <tt class="codeph">preProc.setChunking(Chunking.SINGLE)</tt> and therefore
                           the <tt class="apiname">PreProcessor</tt> generates a single
                           <tt class="tt">.ditac</tt> file.
                        </div>
                     </li>
                  </ol>
               </li>
               <li class="li">
                  <div class="p">Copy the resources of the XSLT stylesheets (CSS stylesheets,
                     icons, etc) to output subdirectory <tt class="filepath">res/</tt>. Note that
                     the images referenced in the DITA source, if any, have already been
                     copied to output subdirectory <tt class="filepath">img/</tt> by the
                     <tt class="apiname">ImageCopier</tt>.
                  </div><pre class="pre">File dstDir = new File("res");
if (!dstDir.exists()) {
    File srcDir = new File(path("../../../xsl/xhtml/resources"));
    try {
        FileUtil.copyDir(srcDir, dstDir, false);
    } catch (IOException e) {
        console.showMessage(e.toString(), Console.MessageType.ERROR);
        cleanUp(preProcFiles);
        return false;
    }
}</pre></li>
               <li class="li">
                  <div class="p">Delete the <tt class="filepath">ditac_lists.ditac_lists</tt> and
                     <tt class="filepath">.ditac</tt> files.
                  </div><pre class="pre">cleanUp(preProcFiles);</pre></li>
            </ol>
            <div id="embed2__I_ibtbzn_" class="section">
               <h3 class="section-title">Compiling and executing the <tt class="apiname">Embed2</tt>
                  sample
               </h3>
               <div class="p">Compile the <tt class="apiname">Embed2</tt> sample by running
                  <b class="cmdname">ant</b> in
                  <tt class="filepath"><i class="varname">ditac_install_dir</i>/doc/manual/embed/</tt>.
               </div>
               <div class="p">Execute
                  the <tt class="apiname">Embed2</tt> sample by running
                  <b class="cmdname">ant</b> <tt class="tt">embed2</tt> in
                  <tt class="filepath"><i class="varname">ditac_install_dir</i>/doc/manual/embed/</tt>.
                  This will convert
                  <tt class="filepath"><i class="varname">ditac_install_dir</i>/docsrc/manual/manual.ditamap</tt>
                  to single HTML 4.1 page
                  <tt class="filepath"><i class="varname">ditac_install_dir</i>/doc/manual/embed/manual.html</tt>.
               </div>
               <div class="p">Note
                  that <tt class="filepath">Embed2.java</tt> contains ``hardwired filenames''.
                  This means that this sample cannot be run from elsewhere than
                  <tt class="filepath"><i class="varname">ditac_install_dir</i>/doc/manual/embed/</tt>.
               </div>
            </div>
         </div>
         <div class="related-links">
            <h3 class="related-links-title">Related information</h3>
            <p class="link">‣ <a href="howItWorks.html#howItWorks__how_it_works">How it works</a></p>
            <p class="link">‣ <a href="embed1.html#embed1">Chapter 8. High-level method: embedding
                  <tt class="apiname">com.xmlmind.ditac.convert.Converter</tt></a></p>
         </div>
         <div class="unordered-members-linkpool">
            <p class="link">‣ <span class="parent-topic-link-item">Parent topic: </span><a href="manual-7.html#I_594lhl_">Part III. Embedding XMLmind DITA Converter in a Java™ application</a></p>
         </div>
      </div>
      <div class="page-navigation-bar">
         <hr class="page-navigation-bottom-separator" />
         <table border="0" cellspacing="0" width="100%" class="page-navigation-layout">
            <tr valign="top">
               <td align="left"><a href="index.html" class="navigation-link" title="First page: XMLmind DITA Converter Manual" accesskey="S"><img class="navigation-icon" src="resources/first.png" alt="First page" width="16" height="16" /></a></td>
               <td align="left"><a href="embed1.html" class="navigation-link" title="Previous page: Part III, Chapter 8. High-level method: embedding com.xmlmind.ditac.convert.Converter" accesskey="P"><img class="navigation-icon" src="resources/previous.png" alt="Previous page" width="16" height="16" /></a></td>
               <td width="25%" align="left"><span class="page-navigation-previous">Part III, Chapter 8. High-level method: embedding com.xmlmind.ditac.convert.Converter</span></td>
               <td width="40%" align="center"><span class="page-navigation-current">Part III, Chapter 9. Low-level method: embedding com.xmlmind.ditac.preprocess.PreProcessor</span> <span class="page-navigation-page">(16 / 19)</span></td>
               <td width="25%" align="right"><span class="page-navigation-next">Appendix A. Translating the messages generated by ditac</span></td>
               <td align="right"><a href="translating_messages.html" class="navigation-link" title="Next page: Appendix A. Translating the messages generated by ditac" accesskey="N"><img class="navigation-icon" src="resources/next.png" alt="Next page" width="16" height="16" /></a></td>
               <td align="right"><a href="manual-8.html" class="navigation-link" title="Last page: Index" accesskey="E"><img class="navigation-icon" src="resources/last.png" alt="Last page" width="16" height="16" /></a></td>
            </tr>
         </table>
      </div>
   </body>
</html>